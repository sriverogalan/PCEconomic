<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="layout/layout.html :: head"></head>
    <header th:replace="layout/layout.html :: navbar"></header>
    <body class="bgbd">
        <main class="container-lg bg-cont mt-md-5 mt-1" th:attr="data-id-subcat=${subcategoria.id}">
            <h1 th:text="${subcategoria.categoria.name} + ' -> ' + ${subcategoria.name}" class="mt-4 text-center"></h1>
            <section id="productes" class="row mt-5 justify-content-center">
                <div id="articles" class="row mt-2 justify-content-center mb-2">
                    <div class="spinner-border text-secondary" role="status" id="loading-wheel">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </section>
        </main>
        <footer th:replace="layout/layout.html :: footer"></footer>
    </body>
    <div th:replace="layout/layout.html :: jquery"></div>
    <script>
        $.ajax({
            url: "/api/propietats",
            type: "GET",
            contentType: "application/json",
            beforeSend: function() {
                $("#loading-wheel").show();
            },
            complete: function() {
                $("#loading-wheel").hide();
            },
            success: function (resp) {
                console.log(resp)
                var imgAux = "";
                var idSubcategoriaAux = "";
                for (var prop of resp) {
                    // recorremos las imagenes de cada propietat para buscar la principal
                    for (var img of prop.imatges) {
                        if (img.principal === true) {
                            imgAux = img.path;
                        }
                    }
                    for (var sub of prop.article.subcategories) {
                        idSubcategoriaAux = sub.id;
                    }
                    if (prop.esPrincipal === true && idSubcategoriaAux === $('main').data('id-subcat')) {
                        $('#articles').append(
                            '<a href="/article/' + prop.article.id + '/' + prop.id + '" class="col-xs-12 col-sm-6 col-lg-4 text-end text-decoration-none card d-flex align-items-center align-self-center">' +
                            '<img src="/img/productes/' + prop.article.id + '/' + prop.id + '/' + imgAux + '" style="width:300px; height:300px; object-fit: contain;" alt="img" class="mt-2">' +
                            '<div class="col-12 justify-content-center row">' +
                            '<div id="' + prop.id + '" class="row justify-content-evenly col-12"></div>' +
                            '<div><p class="text-start h4 col-12">' + prop.article.nom + '</p></div>' +
                            '<span class="text-start h2 text-pc-economic-default bold col-12">' + formatCurrency(prop.preu) + '</span>' +
                            '<span class="text-success col-12 text-start mb-1"> Recíbelo mañana </span>' +
                            '</div>' +
                            '</div>' +
                            '</a>'
                        );
                    }
                    for (props of resp){
                        for (var i of props.imatges) {
                            if (i.principal === true) {
                                imgAux = i.path;
                            }
                        }
                        if (props.esPrincipal === false && props.article.id === prop.article.id) {
                            $('#' + prop.id).append(
                                '<a class="col-4 mt-2 mb-2 row"' +
                                ' href="/article/' + prop.article.id + '/' + props.id
                                + '"> <img src="/img/productes/' + prop.article.id + '/' + props.id + '/' + imgAux + '" class="col-12" alt="img"> </a>'
                            );
                        }
                    }
                    imgAux = ""; // reiniciamos la variable auxiliar
                    idSubcategoriaAux = ""; // reiniciamos la variable auxiliar
                }

            },
        });
        function formatCurrency(amount) {
            return amount.toFixed(2).toString().replace(".", ",").replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " €";
        }
    </script>
</html>